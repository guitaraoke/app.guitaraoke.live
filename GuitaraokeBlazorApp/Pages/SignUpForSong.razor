@page "/song/{slug}"
@inject ISongDatabase db;
@inject IUserTracker tracker;
@inject NavigationManager navMgr;
@attribute [RenderModeServer]

<PageTitle>@(Song.Name ?? "No song")</PageTitle>

@if (Song is null) {
	<p><em>Loading...</em></p>
} else {
	<SongStar Slug="@Slug" IsStarred="@isStarred" />
	<h1>@Song.Title</h1>
	<h2>@Song.Artist</h2>
	@if (Song.Played) {
		<div class="big-emoji">ðŸ˜•</div>
		<h1>Sorry!</h1>
		<p>We already played this one tonight!</p>
	} else {
		<p>Want to sing or play this one?</p>
		<form @onsubmit="@OnSubmit">
			<input type="hidden" name="slug" value="@Slug" />
			<InstrumentSelection @bind-Instruments="@instruments" />
			<input type="text" name="name" placeholder="Your name" @bind-value="@name" required />
			<input type="submit" value="Let's Rock!" />
		</form>
		<p class="small-print">Just your first name is fine. We use a cookie to remember your name, and we don't share it with anybody. Hope that's OK.</p>
	}
}

@code {

	[Parameter]
	public required string Slug { get; set; }

	public required Song Song { get; set; }

	private Instrument instruments;
	private bool isStarred;
	private string? name;

	protected override void OnParametersSet()
	{
		var song = db.FindSong(Slug);
		if (song is null) return;
		Song = song;
		var user = tracker.GetUser();
		name = user.Name;
		isStarred = db.ListStarredSongs(user).Contains(song);
		instruments = (user?.Signups.GetValueOrDefault(song) ?? Array.Empty<Instrument>())
			.ToInstrument();
	}

	private async Task OnSubmit()
	{
		if (String.IsNullOrEmpty(Slug) || String.IsNullOrEmpty(name)) {
			return;
		}

		await SongEndpoints.SignUpForSong(Slug, name, instruments.ToArray(), db, tracker);
		navMgr.NavigateTo("/me", true);
	}
}
